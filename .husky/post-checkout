#!/bin/sh
# Arguments: $1 = previous HEAD, $2 = new HEAD, $3 = branch flag (1 = branch checkout, 0 = file checkout)

# Only run if switching branches (not checking out files)
if [ "$3" = "1" ]; then
  echo "üîÑ Branch switched - checking for differences..."

  # Validate git refs are valid (prevents errors on initial clone or shallow repos)
  if ! git rev-parse "$1" > /dev/null 2>&1 || ! git rev-parse "$2" > /dev/null 2>&1; then
    echo "‚ö†Ô∏è  Unable to validate branch differences (shallow clone or initial checkout)"
    exit 0
  fi

  CHANGED=0

  # Check if dependencies changed (with error handling)
  if git diff --name-only "$1" "$2" 2>/dev/null | grep -q "package.json\|bun.lockb"; then
    echo "‚ö†Ô∏è  üì¶ Dependencies differ between branches"
    echo "   Run 'bun install' to update"
    CHANGED=1
  fi

  # Check if Drizzle schema changed (with error handling)
  if git diff --name-only "$1" "$2" 2>/dev/null | grep -q "lib/db/schema.ts"; then
    echo "‚ö†Ô∏è  üóÑÔ∏è  Drizzle schema differs between branches"
    echo "   Run 'bun run db:generate' to regenerate migrations"
    echo "   Then check drizzle/migrations/ for new files"
    CHANGED=1
  fi

  if [ $CHANGED -eq 0 ]; then
    echo "‚úÖ No critical file differences detected"
  fi
fi
