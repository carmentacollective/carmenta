#!/bin/sh
echo "üîÑ Checking for updates after merge..."

# Clear Next.js cache - merges often change route structure, causing stale type definitions
# See: https://github.com/vercel/next.js/discussions/54075
if [ -d ".next" ]; then
  echo "üóëÔ∏è  Clearing .next cache (prevents stale route types)..."
  rm -rf .next
fi

# Check if HEAD@{1} is valid (fails on initial clone or first commit)
if ! git rev-parse HEAD@{1} > /dev/null 2>&1; then
  echo "‚ö†Ô∏è  Unable to check merge differences (fresh clone or first commit)"
  exit 0
fi

# Check if package.json or lockfile changed
if git diff-tree -r --name-only --no-commit-id HEAD@{1} HEAD 2>/dev/null | grep -q "package.json\|pnpm-lock.yaml"; then
  echo "üì¶ Dependencies changed - running pnpm install..."
  if ! pnpm install --silent; then
    echo "‚ùå pnpm install failed. Please run manually: pnpm install" >&2
    exit 1
  fi
  echo "‚úÖ Dependencies updated"
fi

# Check if Drizzle schema changed
if git diff-tree -r --name-only --no-commit-id HEAD@{1} HEAD 2>/dev/null | grep -q "lib/db/schema.ts"; then
  echo "üóÑÔ∏è  Checking for schema changes..."

  # Count migrations before generating (use find to avoid glob injection)
  BEFORE=$(find drizzle/migrations -maxdepth 1 -name '*.sql' -type f 2>/dev/null | wc -l | tr -d ' ')

  # Generate migrations and capture output to show on failure
  DB_OUTPUT=$(pnpm run db:generate 2>&1)
  DB_EXIT=$?

  if [ $DB_EXIT -ne 0 ]; then
    echo "‚ùå pnpm run db:generate failed:" >&2
    echo "$DB_OUTPUT" >&2
    echo "" >&2
    echo "Please fix the schema errors above and run manually: pnpm run db:generate" >&2
    exit 1
  fi

  # Count migrations after generating
  AFTER=$(find drizzle/migrations -maxdepth 1 -name '*.sql' -type f 2>/dev/null | wc -l | tr -d ' ')

  # Validate counts are numeric
  BEFORE=${BEFORE:-0}
  AFTER=${AFTER:-0}

  if ! [ "$BEFORE" -eq "$BEFORE" ] 2>/dev/null || ! [ "$AFTER" -eq "$AFTER" ] 2>/dev/null; then
    echo "‚ö†Ô∏è  Warning: Could not count migrations reliably" >&2
    echo "   Please check drizzle/migrations/ manually" >&2
    exit 0
  fi

  # Only notify if new migrations were created
  if [ "$AFTER" -gt "$BEFORE" ]; then
    echo "‚úÖ New migrations generated"
    echo ""
    echo "‚ö†Ô∏è  IMPORTANT: Review the generated migration in drizzle/migrations/"
    echo "   Then run: pnpm run db:push (or db:migrate)"
  else
    echo "‚úÖ Schema file updated but no new migrations needed"
  fi
fi

echo "‚úÖ Post-merge checks complete"
