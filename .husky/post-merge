#!/bin/sh
echo "üîÑ Checking for updates after merge..."

# Clear Next.js cache - merges often change route structure, causing stale type definitions
# See: https://github.com/vercel/next.js/discussions/54075
if [ -d ".next" ]; then
  echo "üóëÔ∏è  Clearing .next cache (prevents stale route types)..."
  rm -rf .next
fi

# Check if HEAD@{1} is valid (fails on initial clone or first commit)
if ! git rev-parse HEAD@{1} > /dev/null 2>&1; then
  echo "‚ö†Ô∏è  Unable to check merge differences (fresh clone or first commit)"
  exit 0
fi

# Check if package.json or lockfile changed
if git diff-tree -r --name-only --no-commit-id HEAD@{1} HEAD 2>/dev/null | grep -q "package.json\|pnpm-lock.yaml"; then
  echo "üì¶ Dependencies changed - running pnpm install..."
  if ! pnpm install --silent; then
    echo "‚ùå pnpm install failed. Please run manually: pnpm install" >&2
    exit 1
  fi
  echo "‚úÖ Dependencies updated"
fi

# Check if Drizzle schema changed
if git diff-tree -r --name-only --no-commit-id HEAD@{1} HEAD 2>/dev/null | grep -q "lib/db/schema.ts"; then
  echo "üóÑÔ∏è  Checking for schema changes..."

  # Count migrations before generating
  BEFORE=$(ls -1 drizzle/migrations/*.sql 2>/dev/null | wc -l | tr -d ' ')

  # Generate migrations silently
  if ! pnpm run db:generate > /dev/null 2>&1; then
    echo "‚ùå pnpm run db:generate failed. Please run manually: pnpm run db:generate" >&2
    exit 1
  fi

  # Count migrations after generating
  AFTER=$(ls -1 drizzle/migrations/*.sql 2>/dev/null | wc -l | tr -d ' ')

  # Only notify if new migrations were created
  if [ "$AFTER" -gt "$BEFORE" ]; then
    echo "‚úÖ New migrations generated"
    echo ""
    echo "‚ö†Ô∏è  IMPORTANT: Review the generated migration in drizzle/migrations/"
    echo "   Then run: pnpm run db:push (or db:migrate)"
  else
    echo "‚úÖ Schema file updated but no new migrations needed"
  fi
fi

echo "‚úÖ Post-merge checks complete"
