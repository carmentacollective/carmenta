---
description: When writing tests for typescript
alwaysApply: false
version: 2.0.0
---

# Testing Standards for TypeScript with Vitest

Test behavior, not implementation. Focus on outcomes users care about.

## Core Decisions

Target 90% line / 85% branch coverage. These thresholds catch most paths while avoiding
diminishing returns on defensive branches.

Minimize mocking your own code. Use real database operations with PGlite. Mock external
APIs and non-deterministic operations. A missing migration should fail tests, not slip
to production.

Test names describe outcomes: "returns 400 when email invalid" not "handles bad email".

## PGlite Pattern

One global mock in vitest.setup.ts, zero local mocks. Local `vi.mock("@/lib/db")` calls
override the global and break tests with partial interface errors.

Run migrations in `beforeAll` (once), truncate tables in `afterEach` (fast):

```typescript
beforeAll(async () => {
  await migrate(testDb, { migrationsFolder: "drizzle/migrations" });
});

afterEach(async () => {
  await testDb.execute(sql`TRUNCATE users, connections RESTART IDENTITY CASCADE`);
});
```

Database tests share one PGlite instance - they cannot run concurrently.

## Fixtures

Factory functions with unique IDs prevent collisions:

```typescript
let counter = 0;
export async function createTestUser(options = {}) {
  counter++;
  return db.insert(schema.users).values({
    email: options.email ?? `test-${counter}@example.com`,
    ...options,
  }).returning();
}
```

## Vitest 4 Features

Inline cleanup co-locates setup and teardown:

```typescript
beforeEach(() => {
  setupSomething();
  return () => cleanupSomething();  // runs after each test
});
```

Spy without replacing implementation:

```typescript
vi.mock(import("./analytics.js"), { spy: true });
// original runs, but calls are tracked
```

Concurrent tests with snapshots need local expect:

```typescript
test.concurrent("snapshot", async ({ expect }) => {
  expect(result).toMatchSnapshot();
});
```

## Mock Cleanup

Pick one - using multiple is redundant:

- `vi.clearAllMocks()` - clear call history, keep implementations
- `vi.resetAllMocks()` - clear history AND reset implementations
- `vi.restoreAllMocks()` - restore originals (vi.spyOn only)

## CLI

```bash
vitest run          # once, no watch (CI)
vitest --changed    # only changed files
vitest -t "pattern" # filter by name
vitest -u           # update snapshots
```

Use `pool: "forks"` if native modules or fetch cause issues with default threads.

## Project Isolation

Separate fast unit tests from slow integration tests:

```typescript
projects: [
  { name: "unit", isolate: false, include: ["**/*.unit.test.ts"] },
  { name: "integration", isolate: true, include: ["**/*.integration.test.ts"] },
]
```

## HTTP Status Codes

- 4xx for client errors (bad input, auth failures)
- 500 for server errors and configuration issues
- 503 only for temporary upstream failures (implies "retry later")

Configuration errors should return 500 or fail fast at startup.
