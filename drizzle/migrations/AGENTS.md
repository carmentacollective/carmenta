# Database Migrations

**NEVER manually create or edit migration files in this directory.**

Drizzle tracks migrations through `meta/_journal.json`. Files created manually will
exist but never run—they fail silently.

To create a migration: Edit schema in `lib/db/schema.ts`, then run
`drizzle-kit generate --name descriptive-name`.

## Validating Migration State

Before generating new migrations, always check the chain is valid:

```bash
pnpm drizzle-kit check
```

If this reports errors, fix them before proceeding. See "Repairing Corruption" below.

## Identity Columns: Use generatedByDefaultAsIdentity

For tables with auto-incrementing integer IDs, **always use
`generatedByDefaultAsIdentity()` instead of `generatedAlwaysAsIdentity()`**.

```typescript
// CORRECT - works with Drizzle ORM
id: integer("id").primaryKey().generatedByDefaultAsIdentity();

// WRONG - causes insert failures
id: integer("id").primaryKey().generatedAlwaysAsIdentity();
```

**Why**: Drizzle ORM explicitly includes identity columns in INSERT statements with
`DEFAULT` as the value. PostgreSQL rejects this for `GENERATED ALWAYS` columns but
accepts it for `GENERATED BY DEFAULT` columns.

See: https://github.com/drizzle-team/drizzle-orm/issues/3210

## Branch Merge Gotcha: Snapshot Collisions

When migrations are created on parallel branches and merged, they can create snapshot
chain corruption where multiple snapshots point to the same parent.

### The Problem

Each `meta/XXXX_snapshot.json` file has an `id` and `prevId`. They form a linked list:

```
0032_snapshot.json: id=A, prevId=Z
0033_snapshot.json: id=B, prevId=A  ← points to 0032
0034_snapshot.json: id=C, prevId=B  ← points to 0033
```

When two branches both create migrations from the same base:

```
Branch A: Creates 0033 with prevId pointing to 0032
Branch B: Creates 0033 with prevId pointing to 0032 (COLLISION!)
```

After merge, you have two snapshots both claiming to be "after 0032".

### Detection

```bash
pnpm drizzle-kit check
# Error: [0033_snapshot.json, 0034_snapshot.json] are pointing to a parent snapshot: collision
```

### Prevention

1. **Rebase before generating migrations**: Pull latest main before
   `drizzle-kit generate`
2. **One migration per PR**: Avoid stacking migrations in feature branches
3. **Use descriptive names**: `--name add-user-roles` instead of random suffixes

### Repairing Corruption

If you have a collision, you need to rebuild the snapshot chain:

1. **Identify the broken link**: Check which snapshot's `prevId` is wrong
2. **Create missing snapshots**: If migration 0034 has no snapshot, create it by:
   - Copying the previous snapshot (0033)
   - Applying the schema change from `0034_*.sql`
   - Updating the `id` to a new UUID
   - Setting `prevId` to the previous snapshot's `id`
3. **Fix the next snapshot's prevId**: Update 0035's `prevId` to point to 0034's new
   `id`
4. **Verify**: Run `pnpm drizzle-kit check` until it passes

## Timestamp Ordering

When migrations are created on parallel branches and merged, the `when` timestamps in
`_journal.json` can become out of order. **This causes migrations to be silently
skipped**, even though Drizzle reports "migrations applied successfully".

Example of the problem:

```
Main branch: idx 26 = migration_a (when: 1767997309596)
Feature branch: idx 26 = migration_b (when: 1767997198308)

After merge:
  idx 26 = migration_a (when: 1767997309596) ← LATER
  idx 27 = migration_b (when: 1767997198308) ← EARLIER (skipped!)
```

**Fix**: After merging branches with migrations, check that `when` timestamps are in
ascending order. If not, manually update the later migration's timestamp to be after the
previous one.

CI catches this with the "Check journal timestamp order" step.

@.cursor/rules/drizzle-database-migrations.mdc
